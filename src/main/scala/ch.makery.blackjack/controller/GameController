package ch.makery.blackjack.controller

import ch.makery.blackjack.logic.{Card, Deck}
import scalafx.Includes._
import scalafx.scene.control.Button
import scalafx.scene.image.{Image, ImageView}
import scalafx.scene.Scene
import scalafxml.core.{FXMLView, NoDependencyResolver}
import scalafx.stage.Stage
import scalafx.scene.layout.AnchorPane
import scalafxml.core.macros.sfxml
import scalafx.animation.{KeyFrame, Timeline}
import scalafx.util.Duration

@sfxml
class GameController(val quitGameButton: Button,
                     val hitButton: Button,
                     val standButton: Button,
                     val playerCard1: ImageView,
                     val playerCard2: ImageView,
                     val playerCard3: ImageView,
                     val playerCard4: ImageView,
                     val playerCard5: ImageView,
                     val dealerShownCard2: ImageView,
                     val dealerShownCard3: ImageView,
                     val dealerShownCard4: ImageView,
                     val dealerShownCard5: ImageView,
                     val dealerHiddenCard: ImageView,
                     val dealerHiddenCardExposed: ImageView) {

  private var deck: Deck = _
  private var playerCards: List[Card] = List()
  private var dealerCards: List[Card] = List()
  private var playerCardView: List[ImageView] = _
  private var dealerCardView: List[ImageView] = _

  def startNewGame(): Unit = {
    deck = new Deck()
    deck.shuffle()

    playerCardView = List(playerCard1, playerCard2, playerCard3, playerCard4, playerCard5)
    dealerCardView = List(dealerShownCard2, dealerShownCard3, dealerShownCard4, dealerShownCard5)

    dealCards()
  }

  def dealCards(): Unit = {
    playerCards = deck.dealMultipleCards(2)
    dealerCards = List(deck.dealOneCard(), deck.dealOneCard()) 

    setImageToImageView(playerCard1, playerCards(0).imagePath)
    setImageToImageView(playerCard2, playerCards(1).imagePath)
    setImageToImageView(dealerShownCard2, dealerCards(0).imagePath)
    setImageToImageView(dealerHiddenCard, "card back red.png")

    printHandValues()
  }

  def calculateHandValue(cards: List[Card]): Int = {
    var sum = 0
    var aceCount = 0

    for (card <- cards) {
      sum += card.value
      if (card.value == 11) aceCount += 1
    }

    while (sum > 21 && aceCount > 0) {
      sum -= 10
      aceCount -= 1
    }

    sum
  }

  def printHandValues(): Unit = {
    val playerHandValue = calculateHandValue(playerCards)
    val dealerHandValue = calculateHandValue(List(dealerCards(0))) 

    println(s"Player's hand value: $playerHandValue")
    println(s"Dealer's shown card value: $dealerHandValue")
  }

  def setImageToImageView(imageView: ImageView, imagePath: String): Unit = {
    val imageResource = getClass.getResourceAsStream(s"/images/$imagePath")
    if (imageResource == null) {
      throw new RuntimeException(s"Image resource not found: /images/$imagePath")
    } else {
      imageView.image = new Image(imageResource)
    }
  }

  hitButton.onAction = handle {
    if (playerCards.size < 5) {
      val newCard = deck.dealOneCard()
      playerCards = playerCards :+ newCard
      setImageToImageView(playerCardView(playerCards.size - 1), newCard.imagePath)
      printHandValues()
  
      if (calculateHandValue(playerCards) > 21) {
        println("Player busts!")
        endGame()
      }
    }
  }
  
  standButton.onAction = handle {
    dealerTurn()
  }

  def dealerTurn(): Unit = {
    setImageToImageView(dealerHiddenCardExposed, dealerCards(1).imagePath)
    dealerHiddenCardExposed.visible = true
    dealerHiddenCard.visible = false

    println(s"Dealer's hand value: ${calculateHandValue(dealerCards)}")

    val drawActions = dealerCardView.drop(dealerCards.size - 1).zipWithIndex.map { case (cardView, index) =>
      KeyFrame(Duration(1000 * (index + 1)), onFinished = _ => {
        if (calculateHandValue(dealerCards) < 17 && dealerCards.size < 5) {
          val newCard = deck.dealOneCard()
          dealerCards = dealerCards :+ newCard
          setImageToImageView(cardView, newCard.imagePath)
          println(s"Dealer's hand value: ${calculateHandValue(dealerCards)}")
        }
      })
    }

    val dealerDrawsTimeline = new Timeline {
      keyFrames = drawActions ++ Seq(
        KeyFrame(Duration(1000 * (dealerCards.size + 1)), onFinished = _ => {
          val dealerHandValue = calculateHandValue(dealerCards)
          val playerHandValue = calculateHandValue(playerCards)

          if (dealerHandValue > 21) {
            println("Dealer busts! Player wins!")
          } else if (dealerHandValue >= playerHandValue) {
            println("Dealer wins!")
          } else {
            println("Player wins!")
          }

          endGame()
        })
      )
    }

    dealerDrawsTimeline.play()
  }


  def endGame(): Unit = {
    val resource = getClass.getResource("/interface/GameOver.fxml")
    if (resource == null) {
      throw new RuntimeException("Could not load FXML file for Game Over")
    }

    val root = FXMLView(resource, NoDependencyResolver)
    val scalaRoot = new AnchorPane(root.asInstanceOf[javafx.scene.layout.AnchorPane])

    val stage = quitGameButton.getScene.getWindow.asInstanceOf[javafx.stage.Stage]
    val scalaStage = new Stage(stage)
    scalaStage.scene = new Scene(scalaRoot, 800, 550)
  }

  quitGameButton.onAction = handle {
    endGame()
  }

  startNewGame()
}
